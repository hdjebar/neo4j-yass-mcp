# =============================================================================
# TRANSPORT CONFIGURATION
# =============================================================================

# --- Transport Protocol ---
# Options: stdio, http, sse
#
# stdio:  Standard Input/Output (local IPC)
#         - Best for: Claude Desktop, CLI tools, local development
#         - Connection: Process-based, single client
#         - Use when: Running locally with Claude Desktop
#
# http:   Modern Streamable HTTP (MCP 2025 standard) ⭐ RECOMMENDED for network
#         - Best for: Production deployments, web services, multi-client
#         - Connection: HTTP-based, supports multiple concurrent clients
#         - Use when: Network access, Docker deployments, scalability needed
#         - Features: Full bidirectional, load balancing, auto-scaling
#
# sse:    Server-Sent Events (legacy, backward compatibility)
#         - Best for: Legacy systems requiring SSE
#         - Connection: Unidirectional (server → client)
#         - Use when: Maintaining backward compatibility
#         - Note: Consider migrating to 'http' for new deployments
#
MCP_TRANSPORT=stdio

# --- Server Configuration (Required for http/sse network transports) ---
MCP_SERVER_HOST=127.0.0.1                     # Server binding address (0.0.0.0 for Docker)
MCP_SERVER_PORT=8000                          # Requested server port (will auto-find if unavailable)
MCP_SERVER_PATH=/mcp/                         # API endpoint path (http transport only)

# --- Preferred Ports (for automatic allocation) ---
# Used by the server to find available ports when requested port is busy
# This is NOT an official MCP server variable, it's for port management
PREFERRED_PORTS_MCP_SERVER_PORT="8000 8001 8002"          # Space-separated list of preferred ports

# =============================================================================
# SECURITY CONFIGURATION (for http/sse network transports)
# =============================================================================

# --- DNS Rebinding Protection ---
MCP_SERVER_ALLOWED_HOSTS=localhost,127.0.0.1  # Comma-separated allowed Host headers

# --- CORS Configuration ---
# ⚠️ SECURITY: Default is empty (no CORS) for better security
# Only set this if you need cross-origin access from web applications
#
# Examples:
#   Development: MCP_SERVER_ALLOW_ORIGINS=http://localhost:3000,http://localhost:5173
#   Production:  MCP_SERVER_ALLOW_ORIGINS=https://yourdomain.com
#   All origins (INSECURE): MCP_SERVER_ALLOW_ORIGINS=*
MCP_SERVER_ALLOW_ORIGINS=                      # Comma-separated CORS origins (empty = no CORS)

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# --- Log Level ---
# Options: DEBUG, INFO, WARNING, ERROR, CRITICAL
# Default: INFO (recommended for production)
LOG_LEVEL=INFO

# --- Log Format ---
# Python logging format string
LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s

# =============================================================================
# DOCKER NETWORK CONFIGURATION
# =============================================================================

# --- Docker Network Name (for docker-compose) ---
# Used when running in Docker to create/join networks
MCP_NETWORK_NAME=mcp-network                   # Default network name (default: mcp-network)

# =============================================================================
# NEO4J DATABASE CONFIGURATION
# =============================================================================

# --- Database Connection ---
# For Docker deployments connecting to external Neo4j:
#   - If Neo4j is on host:     NEO4J_URI=bolt://host.docker.internal:7687
#   - If Neo4j in same stack:  NEO4J_URI=bolt://neo4j:7687
#   - If Neo4j in other stack: NEO4J_URI=bolt://neo4j:7687 (configure external network)
#   - If Neo4j AuraDB:         NEO4J_URI=neo4j+s://xxxxx.databases.neo4j.io
NEO4J_URI=bolt://localhost:7687                # Neo4j connection URI
NEO4J_USERNAME=neo4j                           # Database username
NEO4J_PASSWORD=password                        # Database password

# --- Database Selection (Multi-Database Support) ---
# Neo4j Enterprise Edition supports multiple named databases
# Neo4j Community Edition supports only ONE user database (default: "neo4j")
#
# Usage:
#   NEO4J_DATABASE=neo4j       # Default database (works in both Community & Enterprise)
#   NEO4J_DATABASE=analytics   # Custom database (Enterprise Edition only)
#   NEO4J_DATABASE=production  # Custom database (Enterprise Edition only)
#
# Multi-Instance Pattern (for multiple databases):
#   Run separate MCP server instances on different ports, each connected to a different database.
#   See docker-compose.multi-instance.yml for example configuration.
#
# Community Edition Workaround:
#   Use label-based separation within a single database, OR
#   Install DozerDB plugin to add multi-database support to Community Edition
#
NEO4J_DATABASE=neo4j                           # Database name (default: neo4j)

# =============================================================================
# LLM PROVIDER CONFIGURATION
# =============================================================================

# --- Provider Selection ---
# Options: "openai", "anthropic", "google-genai"
LLM_PROVIDER=openai

# --- Model Configuration ---
# Model name (examples for each provider):
#   OpenAI:    gpt-4, gpt-4-turbo-preview, gpt-3.5-turbo
#   Anthropic: claude-3-5-sonnet-20241022, claude-3-opus-20240229, claude-3-sonnet-20240229
#   Google:    gemini-pro, gemini-1.5-pro
LLM_MODEL=gpt-4

# --- Temperature ---
# Range: 0.0 (deterministic) to 1.0 (creative)
# Recommended: 0.0 for Cypher query generation
LLM_TEMPERATURE=0.0

# --- API Key ---
# Provider-specific API key:
#   OpenAI:    sk-...
#   Anthropic: sk-ant-...
#   Google:    (Google API key format)
LLM_API_KEY=your-api-key-here

# --- LLM Streaming (Optional) ---
# Enable token-by-token streaming for LLM responses
# Works best with HTTP transport (MCP_TRANSPORT=http)
# Note: stdio transport (Claude Desktop) may not display streaming well
LLM_STREAMING=false                              # Enable streaming (true/false, default: false)

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# --- Query Timeouts ---
NEO4J_READ_TIMEOUT=30                          # Timeout in seconds for read queries (default: 30)

# --- Access Control ---
NEO4J_READ_ONLY=false                          # Restrict to read-only queries (true/false)

# --- Response Size Limits (Optional) ---
# Limits the number of tokens returned in query responses
# Uncomment and set value if needed for LLM context management
# NEO4J_RESPONSE_TOKEN_LIMIT=10000             # Max tokens for response

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# --- Environment Detection ---
# Options: development, staging, production (or prod)
# This setting controls security restrictions:
# - DEBUG_MODE is blocked in production environments
# - Used for environment-specific configuration
ENVIRONMENT=development                        # Current environment (default: development)

# --- Password Security ---
# ⚠️ IMPORTANT: Change default passwords for production deployments!
# The server will refuse to start with weak passwords unless explicitly allowed.
#
# Weak passwords: password, password123, neo4j, admin, test, CHANGE_ME
#
# Production: Set a strong password in NEO4J_PASSWORD
# Development: Set ALLOW_WEAK_PASSWORDS=true to bypass (NOT for production!)
ALLOW_WEAK_PASSWORDS=false                     # Allow weak passwords (DEVELOPMENT ONLY, default: false)

# --- LangChain Safety Controls ---
# LangChain's allow_dangerous_requests flag controls whether LangChain validates queries
# before execution. When disabled (false), LangChain provides an additional security layer.
#
# ⚠️ WARNING: Setting this to 'true' bypasses LangChain's safety checks!
# Only enable if you trust the LLM output AND have the query sanitizer enabled.
#
# Security layers when LANGCHAIN_ALLOW_DANGEROUS_REQUESTS=false:
#   1. LangChain built-in validation
#   2. Query sanitizer (if SANITIZER_ENABLED=true)
#
# Security layers when LANGCHAIN_ALLOW_DANGEROUS_REQUESTS=true:
#   1. Query sanitizer ONLY (MUST have SANITIZER_ENABLED=true)
LANGCHAIN_ALLOW_DANGEROUS_REQUESTS=false       # Bypass LangChain safety checks (default: false)

# --- Debug Mode ---
# Controls error message verbosity
#
# Production (DEBUG_MODE=false): Returns sanitized, generic error messages
#   - Prevents information leakage (file paths, internal structure, etc.)
#   - Example: "Database operation failed."
#
# Development (DEBUG_MODE=true): Returns detailed error messages
#   - Useful for debugging
#   - Example: "Connection timeout: could not connect to bolt://neo4j:7687"
#
# Full error details are ALWAYS logged to audit logs regardless of this setting.
DEBUG_MODE=false                               # Enable detailed error messages (DEVELOPMENT ONLY, default: false)

# =============================================================================
# QUERY SANITIZATION (Security - SISO Prevention)
# =============================================================================
# SISO: "Shit In, Shit Out" - Malicious input → Compromised system
# Sanitize ALL queries (user input AND LLM-generated) to prevent injection attacks

# --- Input Validation ---
# Enable query sanitization to prevent injection attacks
SANITIZER_ENABLED=true                         # Enable sanitization (default: true)
SANITIZER_STRICT_MODE=false                    # Block suspicious patterns (default: false)
SANITIZER_ALLOW_APOC=false                     # Allow APOC procedures (default: false)
SANITIZER_ALLOW_SCHEMA_CHANGES=false           # Allow schema modifications (default: false)
SANITIZER_MAX_QUERY_LENGTH=10000               # Maximum query length in chars (default: 10000)

# --- UTF-8/Unicode Attack Prevention ---
# Block UTF-8 encoding attacks (zero-width chars, homographs, directional overrides)
SANITIZER_BLOCK_NON_ASCII=false                # Block all non-ASCII chars (default: false)

# =============================================================================
# AUDIT LOGGING (Compliance)
# =============================================================================

# --- Query & Response Logging ---
# Enable audit logging of all queries and responses for compliance
AUDIT_LOG_ENABLED=false                        # Enable audit logging (true/false, default: false)
AUDIT_LOG_DIR=./logs/audit                     # Directory for audit logs (default: ./logs/audit)
AUDIT_LOG_FORMAT=json                          # Format: json or text (default: json)
AUDIT_LOG_ROTATION=daily                       # Rotation: daily, weekly, size (default: daily)
AUDIT_LOG_MAX_SIZE_MB=100                      # Max file size for size-based rotation (default: 100MB)
AUDIT_LOG_RETENTION_DAYS=90                    # Keep audit logs for N days (default: 90)

# --- What to Log ---
AUDIT_LOG_QUERIES=true                         # Log queries (default: true)
AUDIT_LOG_RESPONSES=true                       # Log responses (default: true)
AUDIT_LOG_ERRORS=true                          # Log errors (default: true)
AUDIT_LOG_PII_REDACTION=false                  # Redact potential PII from logs (default: false)

# =============================================================================
# RATE LIMITING (Abuse Prevention)
# =============================================================================

# --- Token Bucket Rate Limiter ---
# Prevents abuse by limiting the number of queries per time window.
# Uses token bucket algorithm: allows burst traffic while maintaining average rate.
#
# Example configurations:
#   Strict:   RATE_LIMIT_REQUESTS=5, RATE_LIMIT_WINDOW_SECONDS=60, RATE_LIMIT_BURST=10
#             → 5 requests/minute, max 10 burst
#   Moderate: RATE_LIMIT_REQUESTS=10, RATE_LIMIT_WINDOW_SECONDS=60, RATE_LIMIT_BURST=20
#             → 10 requests/minute, max 20 burst (default)
#   Relaxed:  RATE_LIMIT_REQUESTS=30, RATE_LIMIT_WINDOW_SECONDS=60, RATE_LIMIT_BURST=60
#             → 30 requests/minute, max 60 burst
RATE_LIMIT_ENABLED=true                        # Enable rate limiting (default: true)
RATE_LIMIT_REQUESTS=10                         # Max requests per time window (default: 10)
RATE_LIMIT_WINDOW_SECONDS=60                   # Time window in seconds (default: 60)
RATE_LIMIT_BURST=20                            # Max burst capacity (default: 2x rate)

# =============================================================================
# MCP TOOL & RESOURCE RATE LIMITS
# =============================================================================

# Decorator-based rate limiting applied to FastMCP tools/resources. Limits are per
# MCP session (ctx.session_id) so each connected client receives its own bucket.

# --- Global Toggle ---
MCP_TOOL_RATE_LIMIT_ENABLED=true               # Enable tool decorators (default: true)

# --- Tool-Specific Limits ---
MCP_QUERY_GRAPH_LIMIT=10                       # Natural language queries per window (default: 10)
MCP_QUERY_GRAPH_WINDOW=60                      # Window in seconds for query_graph (default: 60)

MCP_EXECUTE_CYPHER_LIMIT=10                    # Raw Cypher executions per window (default: 10)
MCP_EXECUTE_CYPHER_WINDOW=60                   # Window in seconds for execute_cypher (default: 60)

MCP_REFRESH_SCHEMA_LIMIT=5                     # Schema refreshes per window (default: 5)
MCP_REFRESH_SCHEMA_WINDOW=120                  # Window in seconds for refresh_schema (default: 120)

# --- Resource Limits (schema + database info) ---
MCP_RESOURCE_RATE_LIMIT_ENABLED=true           # Enable limits on MCP resources (default: true)
MCP_RESOURCE_LIMIT=20                          # Resource reads per window (default: 20)
MCP_RESOURCE_WINDOW=60                         # Window in seconds for resources (default: 60)

# =============================================================================
# ASYNC & PARALLEL EXECUTION
# =============================================================================

# --- Thread Pool Configuration ---
# Maximum number of worker threads for parallel query execution
# Higher values allow more concurrent queries but use more resources
# Recommended: 10-20 for most use cases, 5 for low-resource environments
MCP_MAX_WORKERS=10                             # Max concurrent async operations (default: 10)
